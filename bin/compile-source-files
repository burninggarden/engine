#!/usr/bin/env bash

set -e

mkdir -p dist

if [[ $1 == '--verify' ]]; then
	if [ ! -f dist/.last-compile-time ]; then
		exit 1
	fi

	typeset -i LAST_MODIFICATION_TIME=$(find src test -type f -print0 | xargs -0 stat -f "%m %N" |
		sort -rn | head -1 | awk '{ print $1 }')

	typeset -i LAST_COMPILE_TIME=$(cat dist/.last-compile-time)

	if (( $LAST_MODIFICATION_TIME > $LAST_COMPILE_TIME )); then
		exit 1
	fi

	exit 0
fi

echo "Recompiling..."
rm -rf dist/src
rm -rf dist/test
./node_modules/.bin/tsc
./bin/remap-paths
echo $(date +%s) > dist/.last-compile-time
